<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pants or Shorts Decision App (OWM)</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- START: Mobile Optimization / PWA Prep Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#3f72af">
    <!-- END: Mobile Optimization / PWA Prep Meta Tags -->

    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment (MUST be defined)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Initialization and Auth ---
        let db, auth;
        let userId = null;
        let isAuthReady = false;

        window.firebaseInit = async function() {
            document.getElementById('status-message').textContent = 'Connecting to Firebase...';
            try {
                // setLogLevel('debug'); // Uncomment for debugging
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in using custom token or anonymously
                if (initialAuthToken) {
                    document.getElementById('status-message').textContent = 'Authenticating user token...';
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    document.getElementById('status-message').textContent = 'Signing in anonymously...';
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                    } else {
                        // Use a fallback random ID if authentication fails or is not ready
                        userId = localStorage.getItem('localUserId') || crypto.randomUUID();
                        localStorage.setItem('localUserId', userId);
                        document.getElementById('user-id-display').textContent = `User ID (Anon): ${userId}`;
                    }
                    isAuthReady = true;
                    // Once Auth is ready, load settings and run the check
                    window.loadSettingsAndRunCheck();
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('status-message').textContent = 'Error: Firebase failed to initialize.';
                isAuthReady = true; // Still mark ready to allow app logic to run without persistence
                window.loadSettingsAndRunCheck();
            }
        }

        // --- Firestore Persistence Functions ---

        /** Gets the document reference path for private user settings. */
        const getSettingsRef = () => doc(db, 'artifacts', appId, 'users', userId, 'preferences', 'pants-shorts-threshold');

        window.saveSettings = async function(settings) {
            if (!isAuthReady || !db || !userId) {
                console.warn("Firestore not ready or user ID missing. Cannot save settings.");
                return;
            }
            try {
                // Only saving threshold and unit, API key is hardcoded.
                await setDoc(getSettingsRef(), {
                    threshold: settings.threshold,
                    unit: settings.unit
                });
                console.log("Settings saved successfully.");
                document.getElementById('status-message').textContent = 'Settings saved.';
            } catch (error) {
                console.error("Error saving settings:", error);
                document.getElementById('status-message').textContent = 'Error saving settings.';
            }
        }

        window.loadSettings = async function() {
            if (!isAuthReady || !db || !userId) {
                console.warn("Firestore not ready or user ID missing. Cannot load settings.");
                // Return defaults without API key
                return { threshold: 70, unit: 'F' }; 
            }
            try {
                document.getElementById('status-message').textContent = 'Loading preferences...';
                const docSnap = await getDoc(getSettingsRef());
                if (docSnap.exists()) {
                    console.log("Settings loaded:", docSnap.data());
                    const data = docSnap.data();
                    // Return loaded settings (threshold and unit)
                    return { threshold: data.threshold, unit: data.unit };
                } else {
                    console.log("No settings found, using default.");
                    return { threshold: 70, unit: 'F' }; 
                }
            } catch (error) {
                console.error("Error loading settings:", error);
                document.getElementById('status-message').textContent = 'Error loading preferences.';
                return { threshold: 70, unit: 'F' }; 
            }
        }

        // Start initialization on window load
        window.onload = window.firebaseInit;
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease-in-out;
        }
        .recommendation-box {
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.6s ease;
        }
        /* Custom styles for the result */
        .result-pants {
            background-color: #3f72af; /* Deep Blue */
            color: white;
        }
        .result-shorts {
            background-color: #fce700; /* Bright Yellow */
            color: #1f2937; /* Dark Gray */
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 flex items-center justify-center">

    <div id="app" class="w-full max-w-lg space-y-8">
        <header class="text-center">
            <h1 class="text-4xl font-extrabold text-gray-800 tracking-tight">
                Wardrobe Weather Assistant
            </h1>
            <p class="text-gray-500 mt-1">Pants or Shorts? Let your temperature preference decide.</p>
        </header>

        <!-- Configuration Card -->
        <div class="card bg-white p-6 rounded-xl space-y-6">
            <h2 class="text-2xl font-semibold text-gray-700 border-b pb-3 mb-4">
                Your Comfort Threshold
            </h2>
            
            <div class="flex flex-col sm:flex-row items-end sm:space-x-4 space-y-4 sm:space-y-0">
                <div class="flex-grow w-full">
                    <label for="threshold" class="block text-sm font-medium text-gray-600 mb-1">
                        I wear <span id="garment-preview" class="font-bold text-indigo-600">shorts</span> when it is at or above:
                    </label>
                    <input type="number" id="threshold" value="70" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-lg" placeholder="e.g., 75">
                </div>
                
                <div class="w-full sm:w-auto">
                    <label for="unit" class="block text-sm font-medium text-gray-600 mb-1">
                        Unit
                    </label>
                    <select id="unit" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                        <option value="F">Fahrenheit (Â°F)</option>
                        <option value="C">Celsius (Â°C)</option>
                    </select>
                </div>
            </div>

            <!-- INPUT FIELD FOR MANUAL LOCATION FALLBACK -->
            <div class="w-full pt-4">
                <label for="location-input" class="block text-sm font-medium text-red-500 mb-1 font-bold">
                    <span class="text-gray-600">Enter a **US** City or 5-digit ZIP Code:</span> (Required if GeoLocation is denied)
                </label>
                <input type="text" id="location-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-lg" placeholder="e.g., New York or 10001">
            </div>
            <!-- END INPUT FIELDS -->

            <button onclick="saveAndCheck()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md hover:shadow-lg">
                Save Preference & Check Today
            </button>
        </div>

        <!-- Result Card -->
        <div class="card bg-white p-6 rounded-xl space-y-4">
            <h2 class="text-2xl font-semibold text-gray-700 border-b pb-3 mb-4">
                Today's Recommendation
            </h2>

            <div id="loading" class="text-center p-6 text-gray-500">
                <svg class="animate-spin h-5 w-5 text-indigo-500 inline-block mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Fetching weather and loading settings...
            </div>

            <div id="result-container" class="hidden">
                <!-- Location Display -->
                <p id="location-display" class="text-center text-sm font-semibold text-indigo-600 mb-2">
                    Location: --
                </p>
                <!-- Daily High/Low Display -->
                <div class="flex justify-around text-center mb-6 text-gray-700">
                    <div>
                        <p class="text-sm font-medium">Daily High</p>
                        <p id="daily-high-value" class="text-2xl font-bold text-red-500">--</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium">Daily Low</p>
                        <p id="daily-low-value" class="text-2xl font-bold text-blue-500">--</p>
                    </div>
                </div>

                <!-- Recommendation Box uses the High Temp as the decision point -->
                <p id="decision-temp-display" class="text-center text-gray-600 mb-4 text-lg font-medium">
                    Decision based on High Temp: <span id="current-temp-value" class="font-bold text-gray-800 text-xl">--</span>
                </p>
                <div id="recommendation-box" class="recommendation-box rounded-xl text-3xl font-extrabold uppercase tracking-wider">
                    <!-- Recommendation will be injected here -->
                </div>
            </div>
            
        </div>
        
        <!-- Debug/Status Footer -->
        <div class="text-xs text-gray-400 text-center space-y-1 pt-4">
            <p id="user-id-display">User ID: Loading...</p>
            <p id="status-message">Initializing app...</p>
        </div>

    </div>

    <script>
        // === CORE CONFIGURATION ===
        // ðŸš¨ IMPORTANT: REPLACE THIS PLACEHOLDER WITH YOUR ACTUAL OPENWEATHERMAP API KEY
        const HARDCODED_API_KEY = "89ac443008c143b60f9bee3d2e399a69"; 
        // ==========================

        const fahrenheitToCelsius = (f) => (f - 32) * 5 / 9;

        // --- Core Application State & Logic ---
        let userThreshold = 70;
        let userUnit = 'F';

        document.getElementById('threshold').addEventListener('input', updateGarmentPreview);
        document.getElementById('unit').addEventListener('change', updateGarmentPreview);

        function updateGarmentPreview() {
            const thresholdInput = document.getElementById('threshold');
            const previewElement = document.getElementById('garment-preview');
            
            if (thresholdInput.value === '' || isNaN(parseFloat(thresholdInput.value))) {
                previewElement.textContent = 'shorts';
                return;
            }
            
            // The logic: shorts are worn AT OR ABOVE this temperature.
            previewElement.textContent = 'shorts';
        }

        /**
         * Attempts to get location via GeoLocation, or falls back to user input immediately.
         * Returns an object that either contains {latitude, longitude} OR {inputLocation} OR {error}.
         */
        function getLocationData() {
            const inputLocation = document.getElementById('location-input').value.trim();
            
            // 1. Prioritize manual input if available
            if (inputLocation) {
                document.getElementById('status-message').textContent = `Using provided location: ${inputLocation}...`;
                return Promise.resolve({ inputLocation: inputLocation });
            }

            // 2. Fallback to GeoLocation if no manual input provided
            document.getElementById('status-message').textContent = 'Requesting GeoLocation...';
            
            return new Promise((resolve) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            // Success: GPS available
                            resolve({
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude
                            });
                        },
                        (error) => {
                            // Failure: Geolocation denied or failed
                            let errorMessage;
                            if (error.code === error.PERMISSION_DENIED) {
                                errorMessage = "GeoLocation denied. Please enter a US City/ZIP.";
                            } else {
                                errorMessage = `GeoLocation failed: ${error.message}. Please enter a US City/ZIP.`;
                            }
                            resolve({ error: errorMessage }); 
                        }
                    );
                } else {
                    // Browser does not support geolocation
                    resolve({ error: "GeoLocation is not supported. Please enter a US City/ZIP." });
                }
            });
        }

        /**
         * Fetches real-time weather using OpenWeatherMap API.
         * The function internally converts temperatures to Fahrenheit for the central app logic.
         * @returns {Promise<{current: number, high: number, low: number, locationName: string}>} Temperatures in Fahrenheit.
         */
        async function fetchOpenWeatherMap(locationData, apiKey, unit) {
            if (!apiKey || apiKey === "YOUR_OPENWEATHERMAP_API_KEY_HERE") {
                throw new Error("API Key Missing: The key is not set in the HARDCODED_API_KEY constant in the source code.");
            }
            
            const unitsParam = unit === 'F' ? 'imperial' : 'metric';
            const unitSymbol = unit === 'F' ? 'Â°F' : 'Â°C';
            const OWM_API_URL = "https://api.openweathermap.org/data/2.5/weather?";

            let url;
            if (locationData.latitude && locationData.longitude) {
                // If using coordinates, no country restriction is needed
                url = `${OWM_API_URL}lat=${locationData.latitude}&lon=${locationData.longitude}&units=${unitsParam}&appid=${apiKey}`;
                document.getElementById('status-message').textContent = 'Fetching weather using GPS coordinates...';
            } else if (locationData.inputLocation) {
                let query = locationData.inputLocation.trim();
                
                // Regex to check for a 5-digit number (US ZIP code format)
                // Also ensures it's not a ZIP+4 (e.g. 12345-6789)
                const isZipCode = /^\d{5}$/.test(query);

                if (isZipCode) {
                    // Use the specific ZIP code endpoint format for maximum accuracy in the US.
                    url = `${OWM_API_URL}zip=${query},US&units=${unitsParam}&appid=${apiKey}`;
                    document.getElementById('status-message').textContent = `Fetching weather for US ZIP code ${query}...`;
                } else {
                    // Fallback to city name search, explicitly restricted to the US.
                    query = `${query}, US`; 
                    url = `${OWM_API_URL}q=${encodeURIComponent(query)}&units=${unitsParam}&appid=${apiKey}`;
                    document.getElementById('status-message').textContent = `Fetching weather for City/State: ${query}...`;
                }
            } else {
                throw new Error("No location information available to query OpenWeatherMap.");
            }
            
            

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (!response.ok) {
                    let errorMessage = "Weather API failed.";
                    if (response.status === 401) {
                        errorMessage = "API Error 401: Unauthorized. Check if your hardcoded OpenWeatherMap API Key is correct and active.";
                    } else if (response.status === 404) {
                        errorMessage = `API Error 404: Location not found for "${locationData.inputLocation}". (US only).`;
                        document.getElementById('location-input').classList.add('border-red-500', 'ring-4', 'ring-red-200');
                    } else {
                        errorMessage = `HTTP error! Status: ${response.status}. Message: ${data.message || 'Unknown error'}`;
                    }
                    throw new Error(errorMessage);
                }

                const highTemp = data.main.temp_max;
                const lowTemp = data.main.temp_min;
                const locationName = `${data.name}, ${data.sys.country}`;

                // Convert to Fahrenheit for internal logic if unit is Celsius/Metric
                const highTempF = unit === 'C' ? (highTemp * 9/5) + 32 : highTemp;
                const lowTempF = unit === 'C' ? (lowTemp * 9/5) + 32 : lowTemp;

                // Clear error highlights on success
                document.getElementById('location-input').classList.remove('border-red-500', 'ring-4', 'ring-red-200');

                return {
                    current: highTempF,
                    high: highTempF,
                    low: lowTempF,
                    locationName: locationName
                };

            } catch (error) {
                console.error("OpenWeatherMap API call failed:", error);
                throw error;
            }
        }

        function getRecommendation(decisionTempF, threshold, unit) {
            let decisionTemp;
            let thresholdTemp;

            if (unit === 'C') {
                // Convert both to Celsius for comparison
                decisionTemp = fahrenheitToCelsius(decisionTempF);
                thresholdTemp = parseFloat(threshold);
            } else {
                // Use Fahrenheit for comparison
                decisionTemp = decisionTempF;
                thresholdTemp = parseFloat(threshold);
            }

            // The rule: threshold and up means shorts, under threshold means pants.
            if (decisionTemp >= thresholdTemp) {
                return {
                    garment: 'Shorts',
                    color: 'result-shorts'
                };
            } else {
                return {
                    garment: 'Pants',
                    color: 'result-pants'
                };
            }
        }

        async function saveAndCheck() {
            const thresholdInput = document.getElementById('threshold');
            const unitSelect = document.getElementById('unit');

            userThreshold = parseFloat(thresholdInput.value);
            userUnit = unitSelect.value;
            
            if (isNaN(userThreshold)) {
                document.getElementById('status-message').textContent = 'Error: Please enter a valid number for the threshold.';
                return;
            }

            const settings = {
                threshold: userThreshold,
                unit: userUnit
            };

            // Save settings to Firestore (only threshold and unit)
            if (typeof window.saveSettings === 'function') {
                await window.saveSettings(settings);
            }

            // Run the main check using the hardcoded API key
            await runCheck(userThreshold, userUnit, HARDCODED_API_KEY);
        }
        
        // This function runs the main logic flow
        async function runCheck(threshold, unit, apiKey) {
            const loadingElement = document.getElementById('loading');
            const resultContainer = document.getElementById('result-container');
            const locationDisplay = document.getElementById('location-display');
            const dailyHighValue = document.getElementById('daily-high-value');
            const dailyLowValue = document.getElementById('daily-low-value');
            const decisionTempValue = document.getElementById('current-temp-value');
            const recommendationBox = document.getElementById('recommendation-box');
            
            // Initial key validation
            if (!apiKey || apiKey === "YOUR_OPENWEATHERMAP_API_KEY_HERE") {
                 document.getElementById('status-message').textContent = 'Error: API Key is not set in the source code.';
                 recommendationBox.textContent = 'API KEY REQUIRED';
                 recommendationBox.classList.add('bg-red-200', 'text-red-800');
                 loadingElement.classList.add('hidden');
                 resultContainer.classList.remove('hidden');
                 return;
            }


            loadingElement.classList.remove('hidden');
            resultContainer.classList.add('hidden');
            recommendationBox.className = 'recommendation-box rounded-xl text-3xl font-extrabold uppercase tracking-wider';
            recommendationBox.textContent = 'Checking...';
            locationDisplay.textContent = 'Location: Fetching...';
            dailyHighValue.textContent = '--';
            dailyLowValue.textContent = '--';
            decisionTempValue.textContent = '--';
            
            try {
                // 1. Get Location Data (either GPS or manual input)
                const locationData = await getLocationData();

                if (locationData.error) {
                    throw new Error(locationData.error);
                }
                
                // 2. Fetch Real Weather using OWM
                const tempsF = await fetchOpenWeatherMap(locationData, apiKey, unit);
                
                // We use the High Temperature for the recommendation logic
                const decisionTempF = tempsF.high;

                // 3. Determine Recommendation
                const recommendation = getRecommendation(decisionTempF, threshold, unit);

                // 4. Prepare display values
                // Helper to format temperature based on selected unit
                const formatTemp = (tempF) => unit === 'F' 
                    ? `${tempF.toFixed(0)}Â°F`
                    : `${fahrenheitToCelsius(tempF).toFixed(0)}Â°C`;
                
                // 5. Update UI
                locationDisplay.textContent = `Location: ${tempsF.locationName}`;
                dailyHighValue.textContent = formatTemp(tempsF.high);
                dailyLowValue.textContent = formatTemp(tempsF.low);
                decisionTempValue.textContent = formatTemp(decisionTempF); // The High Temp is the decision temperature
                
                recommendationBox.textContent = `Today calls for ${recommendation.garment}!`;
                recommendationBox.classList.add(recommendation.color);
                
                document.getElementById('status-message').textContent = 'Successfully checked daily forecast.';

            } catch (error) {
                console.error("Failed to run check (Global Catch):", error);
                
                const errorString = String(error);
                let userFriendlyError = errorString.includes('Error:') ? errorString.replace('Error: ', '') : 'Could not get location or weather data.';

                recommendationBox.textContent = 'ERROR';
                recommendationBox.classList.add('bg-red-200', 'text-red-800');
                locationDisplay.textContent = 'Location: Failed';

                // Specific error overrides for common failures
                if (errorString.includes('GeoLocation denied') || errorString.includes('Please enter a US City/ZIP')) {
                    userFriendlyError = "LOCATION REQUIRED: Please enter a US City/ZIP above and press Save & Check.";
                    document.getElementById('location-input').classList.add('border-red-500', 'ring-4', 'ring-red-200');
                } else if (errorString.includes('API Key Missing')) {
                    userFriendlyError = "API KEY REQUIRED: Please set the hardcoded key in the source code.";
                    recommendationBox.textContent = 'API KEY MISSING';
                } else if (errorString.includes('API Error 401')) {
                    userFriendlyError = "API ERROR 401: Invalid hardcoded OWM Key. Check the source code.";
                    recommendationBox.textContent = 'API KEY ERROR';
                } else if (errorString.includes('API Error 404')) {
                    userFriendlyError = "LOCATION ERROR 404: City/ZIP not found. Check your location input field.";
                    document.getElementById('location-input').classList.add('border-red-500', 'ring-4', 'ring-red-200');
                    recommendationBox.textContent = 'LOCATION ERROR';
                }
                
                document.getElementById('status-message').textContent = `Failed: ${userFriendlyError}`;

            } finally {
                loadingElement.classList.add('hidden');
                resultContainer.classList.remove('hidden');
            }
        }
        
        // Function called after Firebase initialization is complete
        window.loadSettingsAndRunCheck = async function() {
            const thresholdInput = document.getElementById('threshold');
            const unitSelect = document.getElementById('unit');
            
            if (typeof window.loadSettings === 'function') {
                const loadedSettings = await window.loadSettings();
                thresholdInput.value = loadedSettings.threshold;
                unitSelect.value = loadedSettings.unit;

                userThreshold = loadedSettings.threshold;
                userUnit = loadedSettings.unit;
            }
            
            updateGarmentPreview();
            // Start the main check immediately after loading settings
            await runCheck(userThreshold, userUnit, HARDCODED_API_KEY);
        }

    </script>
</body>
</html>
